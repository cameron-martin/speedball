{"version":3,"file":"speedball.min.js","sources":["../src/speedball.js"],"sourcesContent":["// @flow\n\nexport type Factory<T> = (x: IResolver) => T;\n\nexport interface IResolver {\n  resolve<T>(name: string): T;\n  after(f: AfterHook): void;\n  willCauseCycle(name: string): bool;\n}\n\ntype AfterHook = (resolver: IResolver) => void;\n\nexport default class Speedball {\n  _factories: { [key: string]: Factory<any> };\n\n  constructor() {\n    this._factories = {};\n  }\n\n  register<T>(name: string, factory: Factory<T>): Speedball {\n    if(name in this._factories) {\n      throw new Error(`An entity is already registered with the name \"${name}\"`);\n    }\n\n    this._factories[name] = factory;\n\n    return this;\n  }\n\n  resolve<T>(name: string): T {\n    var resolvingSession = new ResolvingSession(this._factories);\n    var entity = new Resolver(this._factories, [], resolvingSession).resolve(name);\n\n    resolvingSession.runAfterHooks();\n\n    return entity;\n  }\n}\n\nclass ResolvingSession {\n  _afterHooks: Array<AfterHook>;\n  _factories: { [key: string]: Factory<any> };\n\n  constructor(factories) {\n    this._factories = factories;\n    this._afterHooks = [];\n  }\n\n  addAfterHook(f) {\n    this._afterHooks.push(f);\n  }\n\n  runAfterHooks() {\n    this._afterHooks.forEach(after => {\n      var resolvingSession = new ResolvingSession(this._factories);\n      var resolver = new Resolver(this._factories, [], resolvingSession);\n\n      after(resolver);\n\n      resolvingSession.runAfterHooks();\n    });\n  }\n}\n\nclass Resolver {\n  _factories: { [key: string]: Factory<any> };\n  _ancestors: Array<string>;\n  _resolvingSession: ResolvingSession;\n\n  constructor(factories, ancestors, resolvingSession) {\n    this._factories = factories;\n    this._ancestors = ancestors;\n    this._resolvingSession = resolvingSession;\n\n    Object.freeze(this);\n  }\n\n  resolve(name: string) {\n    if(!(name in this._factories)) {\n      throw new Error('Attempted to resolve an unregistered dependency: ' + name);\n    }\n\n    if(this.willCauseCycle(name)) {\n      throw new Error('Circular dependency detected');\n    }\n\n    const newResolver = new Resolver(this._factories, this._ancestors.concat([name]), this._resolvingSession);\n\n    return this._factories[name](newResolver);\n  }\n\n  after(f: AfterHook): void {\n    this._resolvingSession.addAfterHook(f);\n  }\n\n  willCauseCycle(entityName: string): bool {\n    return this._ancestors.indexOf(entityName) !== -1;\n  }\n}\n\nexport function value<T>(value: T): Factory<T> {\n  return function(resolver) {\n    return value;\n  };\n}\n\nexport function singleton<T>(factory: Factory<T>): Factory<T> {\n  var result;\n\n  return function(resolver) {\n    if(!result) {\n      result = factory(resolver);\n    }\n\n    return result;\n  };\n}\n\nexport function func<T>(func: (...args: any) => T, entities: Array<string> = []): Factory<T> {\n  return function(resolver) {\n    var args = entities.map(entityName => resolver.resolve(entityName));\n    return func(...args);\n  };\n}\n\nexport function construct<T>(constructor: Class<T>, entities: Array<string> = []): Factory<T> {\n  return function(resolver) {\n    var args = entities.map(entity => resolver.resolve(entity));\n\n    return new (constructor: any)(...args);\n  };\n}\n\nexport function props<T>(factory: Factory<T>, props: { [key: string]: string }): Factory<T> {\n  return function(resolver) {\n    var entity = factory(resolver);\n\n    for(let propertyName in props) {\n      let entityName = props[propertyName];\n\n      if(resolver.willCauseCycle(entityName)) {\n        resolver.after(function(resolver) {\n          (entity: any)[propertyName] = resolver.resolve(entityName);\n        });\n      } else {\n        (entity: any)[propertyName] = resolver.resolve(entityName);\n      }\n    }\n\n    return entity;\n  };\n}\n"],"names":["value","resolver","singleton","factory","result","func","entities","arguments","length","undefined","args","map","entityName","resolve","apply","_toConsumableArray","construct","constructor","entity","Function","prototype","bind","concat","props","_loop","propertyName","willCauseCycle","after","Speedball","_classCallCheck","this","_factories","name","Error","resolvingSession","ResolvingSession","Resolver","runAfterHooks","factories","_afterHooks","f","push","_this","forEach","ancestors","_ancestors","_resolvingSession","Object","freeze","newResolver","addAfterHook","indexOf"],"mappings":"2aAoGO,QAASA,GAASA,GACzB,MAAS,UAASC,GAClB,MAAWD,IAIJ,QAASE,GAAaC,GAC7B,GAAMC,EAEN,OAAS,UAASH,GAKlB,MAJQG,KACRA,EAAeD,EAAQF,IAGZG,GAIJ,QAASC,GAAQA,GAAxB,GAAmDC,GAAnDC,UAAAC,QAAA,GAAAC,SAAAF,UAAA,MAAAA,UAAA,EACA,OAAS,UAASN,GAClB,GAAQS,GAAOJ,EAASK,IAAI,SAA5BC,GAAA,MAA0CX,GAASY,QAAQD,IAC3D,OAAWP,GAAXS,MAAAL,OAAAM,EAAmBL,KAIZ,QAASM,GAAaC,GAA7B,GAAoDX,GAApDC,UAAAC,QAAA,GAAAC,SAAAF,UAAA,MAAAA,UAAA,EACA,OAAS,UAASN,GAClB,GAAQS,GAAOJ,EAASK,IAAI,SAA5BO,GAAA,MAAsCjB,GAASY,QAAQK,IAEvD,OAAA,KAAAC,SAAAC,UAAAC,KAAAP,MAAgBG,GAAhB,MAAAK,OAAAP,EAAqCL,OAI9B,QAASa,GAASpB,EAAqBoB,GAC9C,MAAS,UAAStB,GAClB,GAAQiB,GAASf,EAAQF,GADzBuB,EAAA,SAGYC,GACZ,GAAUb,GAAaW,EAAME,EAEpBxB,GAASyB,eAAed,GACjCX,EAAiB0B,MAAM,SAAS1B,GAChCiB,EAAwBO,GAAgBxB,EAASY,QAAQD,KAGzDM,EAAsBO,GAAgBxB,EAASY,QAAQD,GARvD,KAAQ,GAAIa,KAAgBF,GAA5BC,EAAYC,EAYZ,OAAWP,6PAzIUU,EAArB,WAGA,QAAAA,KAAAC,EAAAC,KAAAF,GACAE,KAASC,0CAGT/B,MAAA,SAAcgC,EAAc7B,GAC5B,GAAO6B,IAAQF,MAAKC,WACpB,KAAY,IAAIE,OAAhB,kDAAwED,EAAxE,IAKA,OAFAF,MAASC,WAAWC,GAAQ7B,EAEjB2B,sBAGX9B,MAAA,SAAagC,GACb,GAAQE,GAAmB,GAAIC,GAAiBL,KAAKC,YAC7Cb,EAAS,GAAIkB,GAASN,KAAKC,cAAgBG,GAAkBrB,QAAQmB,EAI7E,OAFAE,GAAqBG,gBAEVnB,WAILiB,EAAN,WAIA,QAAAA,GAAcG,GAAdT,EAAAC,KAAAK,GACAL,KAASC,WAAaO,EACtBR,KAASS,+CAGTvC,MAAA,SAAewC,GACfV,KAASS,YAAYE,KAAKD,0BAG1BxC,MAAA,WAAA,GAAA0C,GAAAZ,IACAA,MAASS,YAAYI,QAAQ,SAA7BhB,GACA,GAAUO,GAAmB,GAAIC,GAAiBO,EAAKX,YAC7C9B,EAAW,GAAImC,GAASM,EAAKX,cAAgBG,EAEvDP,GAAY1B,GAEZiC,EAAuBG,2BAKjBD,EAAN,WAKA,QAAAA,GAAcE,EAAWM,EAAWV,GAApCL,EAAAC,KAAAM,GACAN,KAASC,WAAaO,EACtBR,KAASe,WAAaD,EACtBd,KAASgB,kBAAoBZ,EAE7Ba,OAAWC,OAAOlB,iCAGlB9B,MAAA,SAAUgC,GACV,KAASA,IAAQF,MAAKC,YACtB,KAAY,IAAIE,OAAM,oDAAsDD,EAG5E,IAAOF,KAAKJ,eAAeM,GAC3B,KAAY,IAAIC,OAAM,+BAGtB,IAAUgB,GAAc,GAAIb,GAASN,KAAKC,WAAYD,KAAKe,WAAWvB,QAAQU,IAAQF,KAAKgB,kBAE3F,OAAWhB,MAAKC,WAAWC,GAAMiB,kBAGjCjD,MAAA,SAAQwC,GACRV,KAASgB,kBAAkBI,aAAaV,2BAGxCxC,MAAA,SAAiBY,GACjB,MAAmD,KAAxCkB,KAAKe,WAAWM,QAAQvC"}