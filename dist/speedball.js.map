{"version":3,"file":"speedball.js","sources":["../src/speedball.js"],"sourcesContent":["// @flow\n\nexport type Factory<T> = (x: IResolver) => T;\n\nexport interface IResolver {\n  resolve<T>(name: string): T;\n  after(f: AfterHook): void;\n  willCauseCycle(name: string): bool;\n}\n\nexport type AfterHook = (resolver: IResolver) => void;\n\nexport default class Speedball {\n  _factories: { [key: string]: Factory<any> };\n\n  constructor() {\n    this._factories = {};\n  }\n\n  register<T>(name: string, factory: Factory<T>): Speedball {\n    if(name in this._factories) {\n      throw new Error(`An entity is already registered with the name \"${name}\"`);\n    }\n\n    this._factories[name] = factory;\n\n    return this;\n  }\n\n  resolve<T>(name: string): T {\n    var resolvingSession = new ResolvingSession(this._factories);\n    var entity = new Resolver(this._factories, [], resolvingSession).resolve(name);\n\n    resolvingSession.runAfterHooks();\n\n    return entity;\n  }\n}\n\nclass ResolvingSession {\n  _afterHooks: Array<AfterHook>;\n  _factories: { [key: string]: Factory<any> };\n\n  constructor(factories) {\n    this._factories = factories;\n    this._afterHooks = [];\n  }\n\n  addAfterHook(f) {\n    this._afterHooks.push(f);\n  }\n\n  runAfterHooks() {\n    this._afterHooks.forEach(after => {\n      var resolvingSession = new ResolvingSession(this._factories);\n      var resolver = new Resolver(this._factories, [], resolvingSession);\n\n      after(resolver);\n\n      resolvingSession.runAfterHooks();\n    });\n  }\n}\n\nclass Resolver {\n  _factories: { [key: string]: Factory<any> };\n  _ancestors: Array<string>;\n  _resolvingSession: ResolvingSession;\n\n  constructor(factories, ancestors, resolvingSession) {\n    this._factories = factories;\n    this._ancestors = ancestors;\n    this._resolvingSession = resolvingSession;\n\n    Object.freeze(this);\n  }\n\n  resolve(name: string) {\n    if(!(name in this._factories)) {\n      throw new Error('Attempted to resolve an unregistered dependency: ' + name);\n    }\n\n    if(this.willCauseCycle(name)) {\n      throw new Error('Circular dependency detected');\n    }\n\n    const newResolver = new Resolver(this._factories, this._ancestors.concat([name]), this._resolvingSession);\n\n    return this._factories[name](newResolver);\n  }\n\n  after(f: AfterHook): void {\n    this._resolvingSession.addAfterHook(f);\n  }\n\n  willCauseCycle(entityName: string): bool {\n    return this._ancestors.indexOf(entityName) !== -1;\n  }\n}\n\nexport function value<T>(value: T): Factory<T> {\n  return function(resolver) {\n    return value;\n  };\n}\n\nexport function singleton<T>(factory: Factory<T>): Factory<T> {\n  var result;\n\n  return function(resolver) {\n    if(!result) {\n      result = factory(resolver);\n    }\n\n    return result;\n  };\n}\n\nexport function func<T>(func: (...args: any) => T, entities: Array<string> = []): Factory<T> {\n  return function(resolver) {\n    var args = entities.map(entityName => resolver.resolve(entityName));\n    return func(...args);\n  };\n}\n\nexport function construct<T>(constructor: Class<T>, entities: Array<string> = []): Factory<T> {\n  return function(resolver) {\n    var args = entities.map(entity => resolver.resolve(entity));\n\n    return new (constructor: any)(...args);\n  };\n}\n\nexport function props<T>(factory: Factory<T>, props: { [key: string]: string }): Factory<T> {\n  return function(resolver) {\n    var entity = factory(resolver);\n\n    for(let propertyName in props) {\n      let entityName = props[propertyName];\n\n      if(resolver.willCauseCycle(entityName)) {\n        resolver.after(function(resolver) {\n          (entity: any)[propertyName] = resolver.resolve(entityName);\n        });\n      } else {\n        (entity: any)[propertyName] = resolver.resolve(entityName);\n      }\n    }\n\n    return entity;\n  };\n}\n"],"names":[],"mappings":"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"}