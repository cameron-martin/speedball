{"version":3,"file":"speedball.js","sources":["../src/speedball.js"],"sourcesContent":["// @flow\n\nexport type Factory<T> = (x: IResolver) => T;\n\nexport interface IResolver {\n  resolve<T>(name: string): T;\n  after(f: AfterHook): void;\n  willCauseCycle(name: string): bool;\n}\n\ntype AfterHook = (resolver: IResolver) => void;\n\nexport default class Speedball {\n  _factories: { [key: string]: Factory<any> };\n\n  constructor() {\n    this._factories = {};\n  }\n\n  register<T>(name: string, factory: Factory<T>): Speedball {\n    if(name in this._factories) {\n      throw new Error(`An entity is already registered with the name \"${name}\"`);\n    }\n\n    this._factories[name] = factory;\n\n    return this;\n  }\n\n  resolve<T>(name: string): T {\n    var resolvingSession = new ResolvingSession(this._factories);\n    var entity = new Resolver(this._factories, [], resolvingSession).resolve(name);\n\n    resolvingSession.runAfterHooks();\n\n    return entity;\n  }\n}\n\nclass ResolvingSession {\n  _afterHooks: Array<AfterHook>;\n  _factories: { [key: string]: Factory<any> };\n\n  constructor(factories) {\n    this._factories = factories;\n    this._afterHooks = [];\n  }\n\n  addAfterHook(f) {\n    this._afterHooks.push(f);\n  }\n\n  runAfterHooks() {\n    this._afterHooks.forEach(after => {\n      var resolvingSession = new ResolvingSession(this._factories);\n      var resolver = new Resolver(this._factories, [], resolvingSession);\n\n      after(resolver);\n\n      resolvingSession.runAfterHooks();\n    });\n  }\n}\n\nclass Resolver {\n  _factories: { [key: string]: Factory<any> };\n  _ancestors: Array<string>;\n  _resolvingSession: ResolvingSession;\n\n  constructor(factories, ancestors, resolvingSession) {\n    this._factories = factories;\n    this._ancestors = ancestors;\n    this._resolvingSession = resolvingSession;\n\n    Object.freeze(this);\n  }\n\n  resolve(name: string) {\n    if(!(name in this._factories)) {\n      throw new Error('Attempted to resolve an unregistered dependency: ' + name);\n    }\n\n    if(this.willCauseCycle(name)) {\n      throw new Error('Circular dependency detected');\n    }\n\n    const newResolver = new Resolver(this._factories, this._ancestors.concat([name]), this._resolvingSession);\n\n    return this._factories[name](newResolver);\n  }\n\n  after(f: AfterHook): void {\n    this._resolvingSession.addAfterHook(f);\n  }\n\n  willCauseCycle(entityName: string): bool {\n    return this._ancestors.indexOf(entityName) !== -1;\n  }\n}\n\nexport function value<T>(value: T): Factory<T> {\n  return function(resolver) {\n    return value;\n  };\n}\n\nexport function singleton<T>(factory: Factory<T>): Factory<T> {\n  var result;\n\n  return function(resolver) {\n    if(!result) {\n      result = factory(resolver);\n    }\n\n    return result;\n  };\n}\n\nexport function func<T>(func: (...args: any) => T, entities: Array<string> = []): Factory<T> {\n  return function(resolver) {\n    var args = entities.map(entityName => resolver.resolve(entityName));\n    return func(...args);\n  };\n}\n\nexport function construct<T>(constructor: Class<T>, entities: Array<string> = []): Factory<T> {\n  return function(resolver) {\n    var args = entities.map(entity => resolver.resolve(entity));\n\n    return new (constructor: any)(...args);\n  };\n}\n\nexport function props<T>(factory: Factory<T>, props: { [key: string]: string }): Factory<T> {\n  return function(resolver) {\n    var entity = factory(resolver);\n\n    for(let propertyName in props) {\n      let entityName = props[propertyName];\n\n      if(resolver.willCauseCycle(entityName)) {\n        resolver.after(function(resolver) {\n          (entity: any)[propertyName] = resolver.resolve(entityName);\n        });\n      } else {\n        (entity: any)[propertyName] = resolver.resolve(entityName);\n      }\n    }\n\n    return entity;\n  };\n}\n"],"names":[],"mappings":"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"}